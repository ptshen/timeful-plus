services:
  # MongoDB Database
  mongodb:
    image: mongo:6.0
    container_name: timeful-mongodb
    restart: unless-stopped
    # Run as mongodb user (uid 999 in official mongo image)
    user: "999:999"
    environment:
      MONGO_INITDB_DATABASE: schej-it
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - timeful-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    # Security options
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID

  # Backend API Server
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: timeful-backend
    restart: unless-stopped
    # Run as non-root user (defined in Dockerfile)
    user: "1000:1000"
    expose:
      - "3002"
    environment:
      # MongoDB Configuration
      - MONGO_URI=mongodb://mongodb:27017
      - MONGO_DB_NAME=schej-it
      
      # Google OAuth (Required for calendar integration)
      # Create credentials at https://console.cloud.google.com/
      - CLIENT_ID=${CLIENT_ID}
      - CLIENT_SECRET=${CLIENT_SECRET}
      
      # Microsoft OAuth (Optional - for Outlook calendar integration)
      # Create app registration at https://portal.azure.com/
      - MICROSOFT_CLIENT_ID=${MICROSOFT_CLIENT_ID:-}
      - MICROSOFT_CLIENT_SECRET=${MICROSOFT_CLIENT_SECRET:-}
      
      # Encryption (Required)
      # Generate with: openssl rand -base64 32
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      
      # Optional: Email Configuration (for notifications)
      - GMAIL_APP_PASSWORD=${GMAIL_APP_PASSWORD:-}
      - SCHEJ_EMAIL_ADDRESS=${SCHEJ_EMAIL_ADDRESS:-}
      
      # Optional: Listmonk Configuration (for email campaigns)
      - LISTMONK_URL=${LISTMONK_URL:-}
      - LISTMONK_USERNAME=${LISTMONK_USERNAME:-}
      - LISTMONK_PASSWORD=${LISTMONK_PASSWORD:-}
      - LISTMONK_LIST_ID=${LISTMONK_LIST_ID:-}
      
      # Optional: Slack Configuration (for monitoring)
      - SLACK_DEV_WEBHOOK_URL=${SLACK_DEV_WEBHOOK_URL:-}
      - SLACK_PROD_WEBHOOK_URL=${SLACK_PROD_WEBHOOK_URL:-}
      
      # Optional: Stripe Configuration (for payments)
      - STRIPE_API_KEY=${STRIPE_API_KEY:-}
      
      # Optional: Self-Hosted Premium (auto-unlock premium features)
      # Set to "true" to enable premium features for all users without Stripe
      - SELF_HOSTED_PREMIUM=${SELF_HOSTED_PREMIUM:-true}
      
      # Optional: Google Cloud Service Account (for advanced features)
      - SERVICE_ACCOUNT_KEY_PATH=${SERVICE_ACCOUNT_KEY_PATH:-}
      
      # Optional: Base URL (IMPORTANT for Google OAuth with custom domains)
      # Set this to your domain if hosting at a custom URL
      # Example: https://yourdomain.com or http://localhost:3002
      - BASE_URL=${BASE_URL:-}
      
      # Optional: CORS Allowed Origins (for custom domains)
      # Comma-separated list of allowed origins
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-}
      
      # Server Configuration
      - GIN_MODE=release
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - timeful-network
    volumes:
      # Mount logs directory to persist logs
      - backend_logs:/app/logs
    # Security options
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  # Frontend Web Server (Development Mode)
  frontend:
    image: node:20-alpine
    container_name: timeful-frontend
    restart: unless-stopped
    working_dir: /app
    ports:
      - "3002:8080"
    depends_on:
      - backend
    networks:
      - timeful-network
    volumes:
      - ./frontend:/app
      - ./config.js:/app/public/config.js
      - /app/node_modules
    command: sh -c "npm install && npm run serve"
    # Security options
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

networks:
  timeful-network:
    driver: bridge

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  backend_logs:
    driver: local
